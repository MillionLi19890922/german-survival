<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Âæ∑ËØ≠ÁîüÂ≠ò">
    <meta name="theme-color" content="#007AFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1C1C1E" media="(prefers-color-scheme: dark)">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Âæ∑ËØ≠ÁîüÂ≠òÊâãÂÜå</title>
    <style>
        :root {
            --bg-primary: #F5F5F7;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #E5E5EA;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --accent-light: rgba(0, 122, 255, 0.1);
            --border: rgba(0, 0, 0, 0.1);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --danger: #FF3B30;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1C1C1E;
                --bg-secondary: #2C2C2E;
                --bg-tertiary: #3A3A3C;
                --text-primary: #FFFFFF;
                --text-secondary: #8E8E93;
                --accent: #0A84FF;
                --accent-light: rgba(10, 132, 255, 0.15);
                --border: rgba(255, 255, 255, 0.1);
                --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: calc(var(--safe-top) + 12px) 16px 12px;
            border-bottom: 1px solid var(--border);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
        }

        .header-btn.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .content {
            flex: 1;
            padding: 16px;
            padding-bottom: calc(80px + var(--safe-bottom));
            overflow-y: auto;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 0 calc(8px + var(--safe-bottom));
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .tab-item.active {
            color: var(--accent);
        }

        .tab-item .icon {
            font-size: 24px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .category-section {
            margin-bottom: 24px;
        }

        .category-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .category-section-header h2 {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .category-item {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px 8px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border: none;
            color: var(--text-primary);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;
        }

        .category-item:active {
            transform: scale(0.98);
        }

        .category-content {
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .more-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%;
        }

        .more-btn:active {
            background: var(--bg-tertiary);
        }

        .category-item .emoji {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .category-item .name {
            font-size: 12px;
            font-weight: 500;
            line-height: 1.3;
        }

        .category-item.add-btn {
            background: var(--accent-light);
            border: 2px dashed var(--accent);
            cursor: pointer;
        }

        .category-item.add-btn .emoji {
            color: var(--accent);
        }

        .add-category-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-light);
            border: 2px dashed var(--accent);
            border-radius: 16px;
            color: var(--accent);
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }

        .phrase-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .phrase-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--card-shadow);
            position: relative;
        }

        .phrase-card .german {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
            padding-right: 40px;
        }

        .phrase-card .chinese {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .phrase-card .favorite-btn {
            position: absolute;
            top: 12px;
            right: 44px;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phrase-card .more-btn {
            top: 12px;
            right: 10px;
            width: 32px;
            height: 32px;
        }

        .phrase-card .favorite-btn.favorited {
            background: var(--accent-light);
        }

        .add-phrase-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-light);
            border: 2px dashed var(--accent);
            border-radius: 16px;
            color: var(--accent);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .ai-section {
            margin-bottom: 24px;
        }

        .search-box {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--card-shadow);
        }

        .search-box h3 {
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        .search-btn {
            padding: 12px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .search-btn:disabled {
            opacity: 0.5;
        }

        .ai-result {
            margin-top: 16px;
            padding: 16px;
            background: var(--accent-light);
            border-radius: 12px;
            display: none;
        }

        .ai-result.visible {
            display: block;
        }

        .ai-result .german {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .ai-result .chinese {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .ai-result .note {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .ai-result-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .ai-result-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
        }

        .ai-result-btn.save {
            background: var(--accent);
            color: white;
        }

        .ai-result-btn.copy {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .ai-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            color: var(--text-secondary);
        }

        .ai-loading.visible {
            display: flex;
        }

        .ai-loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .settings-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .settings-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item label {
            font-size: 16px;
        }

        .settings-item input[type="password"],
        .settings-item input[type="text"] {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .settings-item button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .settings-item .save-btn {
            background: var(--accent);
            color: white;
        }

        .settings-item .danger-btn {
            background: var(--danger);
            color: white;
        }

        .settings-note {
            padding: 12px 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .settings-note a {
            color: var(--accent);
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .scene-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .scene-header .emoji {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .scene-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-group input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-picker button {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
        }

        .emoji-picker button.selected {
            background: var(--accent-light);
            border: 2px solid var(--accent);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 300;
            min-width: 150px;
            overflow: hidden;
            display: none;
        }

        .context-menu.visible {
            display: block;
        }

        .context-menu button {
            width: 100%;
            padding: 14px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .context-menu button:active {
            background: var(--bg-tertiary);
        }

        .context-menu button.danger {
            color: var(--danger);
        }

        /* AI Generate */
        .level-selector {
            display: flex;
            gap: 8px;
        }

        .level-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            text-align: center;
        }

        .level-btn.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            color: var(--accent);
        }

        .generated-phrases {
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .generated-phrase {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .generated-phrase input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 4px;
        }

        .generated-phrase-content {
            flex: 1;
        }

        .generated-phrase .de {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .generated-phrase .zh {
            font-size: 14px;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="header">
            <button class="header-btn hidden" id="backBtn" onclick="goBack()">‚Üê</button>
            <h1 id="headerTitle">Âæ∑ËØ≠ÁîüÂ≠òÊâãÂÜå</h1>
            <button class="header-btn" id="headerRightBtn" onclick="showPage('settings')">‚öôÔ∏è</button>
        </header>
        <main class="content">
            <div class="page active" id="page-home">
                <div class="ai-section">
                    <div class="search-box">
                        <h3>ü§ñ ÈóÆ AI</h3>
                        <div class="search-input-wrapper">
                            <input type="text" class="search-input" id="aiInput" placeholder="ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑ‰∏≠Êñá...">
                            <button class="search-btn" id="aiSearchBtn" onclick="askAI()">Êü•ËØ¢</button>
                        </div>
                        <div class="ai-loading" id="aiLoading">
                            <div class="spinner"></div><span>ÊÄùËÄÉ‰∏≠...</span>
                        </div>
                        <div class="ai-result" id="aiResult">
                            <div class="german" id="aiResultGerman"></div>
                            <div class="chinese" id="aiResultChinese"></div>
                            <div class="note" id="aiResultNote"></div>
                            <div class="ai-result-actions">
                                <button class="ai-result-btn save" onclick="saveAIResult()">‚≠ê Êî∂Ëóè</button>
                                <button class="ai-result-btn copy" onclick="copyAIResult()">üìã Â§çÂà∂</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="categoriesContainer"></div>
                <button class="add-category-btn" onclick="showAddCategoryModal()">‚ûï Ê∑ªÂä†Êñ∞ÂàÜÁ±ª</button>
            </div>
            <div class="page" id="page-scene">
                <div class="scene-header" id="sceneHeader">
                    <div class="emoji"></div>
                    <h2></h2>
                </div>
                <div class="phrase-list" id="phraseList"></div>
                <button class="add-phrase-btn" onclick="showAddPhraseModal()">‚ûï Ê∑ªÂä†Áü≠Âè•</button>
            </div>
            <div class="page" id="page-favorites">
                <div class="empty-state" id="emptyFavorites">
                    <div class="icon">‚≠ê</div>
                    <h3>ÊöÇÊó†Êî∂Ëóè</h3>
                    <p>ÁÇπÂáªÁü≠Âè•Âç°Áâá‰∏äÁöÑÊòüÊòüÊù•Êî∂Ëóè</p>
                </div>
                <div class="phrase-list" id="favoritesList"></div>
            </div>
            <div class="page" id="page-settings">
                <div class="settings-section">
                    <div class="settings-item"><label>API Key</label><input type="password" id="apiKeyInput"
                            placeholder="ËæìÂÖ• Gemini API Key"><button class="save-btn" onclick="saveApiKey()">‰øùÂ≠ò</button>
                    </div>
                </div>
                <div class="settings-note">AI ÂäüËÉΩÈúÄË¶Å Gemini API Key„ÄÇ<a href="https://aistudio.google.com/app/apikey"
                        target="_blank">Ëé∑Âèñ API Key</a></div>
                <div class="settings-section">
                    <div class="settings-item"><label>ÂØºÂá∫Êï∞ÊçÆ</label><button class="save-btn"
                            onclick="exportData()">ÂØºÂá∫</button></div>
                    <div class="settings-item"><label>ÂØºÂÖ•Êï∞ÊçÆ</label><input type="file" id="importFile" accept=".json"
                            onchange="importData(event)" style="display:none"><button class="save-btn"
                            onclick="document.getElementById('importFile').click()">ÂØºÂÖ•</button></div>
                    <div class="settings-item"><label>ÊÅ¢Â§çÈªòËÆ§Êï∞ÊçÆ</label><button class="danger-btn"
                            onclick="resetToDefault()">ÊÅ¢Â§ç</button></div>
                    <div class="settings-item"><label>Ê∏ÖÈô§ÊâÄÊúâÊî∂Ëóè</label><button class="danger-btn"
                            onclick="clearFavorites()">Ê∏ÖÈô§</button></div>
                </div>
            </div>
        </main>
        <nav class="tab-bar">
            <button class="tab-item active" onclick="showPage('home')" data-page="home"><span
                    class="icon">üè†</span><span>Âú∫ÊôØ</span></button>
            <button class="tab-item" onclick="showPage('favorites')" data-page="favorites"><span
                    class="icon">‚≠ê</span><span>Êî∂Ëóè</span></button>
        </nav>
        <div class="toast" id="toast"></div>
    </div>
    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Ê†áÈ¢ò</h3><button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>
    <div class="context-menu" id="contextMenu"></div>
    <script>
        const DEFAULT_DATA = { categories: { "È§êÈ•ÆÁ±ª": [{ id: "restaurant", emoji: "üçΩÔ∏è", name: "È§êÂéÖÁÇπÈ§ê" }, { id: "cafe", emoji: "‚òï", name: "ÂíñÂï°ÂéÖ" }, { id: "fastfood", emoji: "üçî", name: "Âø´È§êÂ§ñÂçñ" }, { id: "bar", emoji: "üç∫", name: "ÈÖíÂêßÂ§úÂ∫ó" }, { id: "bakery", emoji: "ü•ê", name: "Èù¢ÂåÖÂ∫ó" }], "Âá∫Ë°åÁ±ª": [{ id: "transport", emoji: "üöá", name: "ÂÖ¨ÂÖ±‰∫§ÈÄö" }, { id: "train", emoji: "üöÑ", name: "ÁÅ´ËΩ¶ÈïøÈÄî" }, { id: "taxi", emoji: "üöï", name: "ÊâìËΩ¶ÁßüËΩ¶" }, { id: "directions", emoji: "üó∫Ô∏è", name: "ÈóÆË∑ØÊåáË∑Ø" }, { id: "airport", emoji: "‚úàÔ∏è", name: "Êú∫Âú∫ÁôªÊú∫" }, { id: "car", emoji: "‚õΩ", name: "Âä†Ê≤π‰øÆËΩ¶" }], "Ë¥≠Áâ©Á±ª": [{ id: "supermarket", emoji: "üõí", name: "Ë∂ÖÂ∏ÇË¥≠Áâ©" }, { id: "clothing", emoji: "üëó", name: "ÊúçË£ÖÂ∫ó" }, { id: "electronics", emoji: "üì±", name: "ÁîµÂô®Â∫ó" }, { id: "returns", emoji: "üì¶", name: "ÁΩëË¥≠ÈÄÄË¥ß" }], "Á§æ‰∫§Á±ª": [{ id: "greeting", emoji: "üëã", name: "Êó•Â∏∏ÈóÆÂÄô" }, { id: "intro", emoji: "üôã", name: "Ëá™Êàë‰ªãÁªç" }, { id: "neighbor", emoji: "üèòÔ∏è", name: "ÈÇªÂ±Ö‰∫§ÊµÅ" }, { id: "thanks", emoji: "üôè", name: "ÈÅìÊ≠âÊÑüË∞¢" }, { id: "weather", emoji: "üå§Ô∏è", name: "Â§©Ê∞îÈó≤ËÅä" }], "ÂåªÁñóÁ±ª": [{ id: "doctor", emoji: "üè•", name: "ÁúãÁóÖÂ∞±Âåª" }, { id: "pharmacy", emoji: "üíä", name: "ËçØÂ∫ó‰π∞ËçØ" }, { id: "dentist", emoji: "ü¶∑", name: "ÁâôÂåªÁúºÁßë" }], "ÁîüÊ¥ªÁ±ª": [{ id: "housing", emoji: "üè†", name: "ÁßüÊàøÊâæÊàø" }, { id: "repair", emoji: "üîß", name: "Êä•‰øÆÁª¥Êä§" }, { id: "post", emoji: "üìÆ", name: "ÈÇÆÂ±ÄÂø´ÈÄí" }, { id: "bank", emoji: "üè¶", name: "Èì∂Ë°å‰∏öÂä°" }, { id: "haircut", emoji: "üíá", name: "ÁêÜÂèëÁæéÂÆπ" }, { id: "gym", emoji: "üèãÔ∏è", name: "ÂÅ•Ë∫´Êàø" }, { id: "laundry", emoji: "üß∫", name: "Ê¥óË°£Â∫ó" }], "Âäû‰∫ãÁ±ª": [{ id: "cityhall", emoji: "üèõÔ∏è", name: "Â∏ÇÊîøÂéÖ" }, { id: "telecom", emoji: "üì∂", name: "Áîµ‰ø°ËøêËê•ÂïÜ" }], "Â∑•‰ΩúÁ±ª": [{ id: "office", emoji: "üíº", name: "ËÅåÂú∫Ê≤üÈÄö" }, { id: "leave", emoji: "üèñÔ∏è", name: "ËØ∑ÂÅá‰ºëÂÅá" }, { id: "interview", emoji: "ü§ù", name: "Èù¢ËØïÊ±ÇËÅå" }], "Á¥ßÊÄ•Á±ª": [{ id: "emergency", emoji: "üÜò", name: "Êä•Ë≠¶Ê±ÇÂä©" }, { id: "complaint", emoji: "üì¢", name: "ÊäïËØâÁª¥ÊùÉ" }] }, phrases: { restaurant: [{ de: "Ich h√§tte gerne...", zh: "ÊàëÊÉ≥Ë¶Å..." }, { de: "Die Speisekarte, bitte.", zh: "ËØ∑ÁªôÊàëËèúÂçï„ÄÇ" }, { de: "Was empfehlen Sie?", zh: "ÊÇ®Êé®Ëçê‰ªÄ‰πàÔºü" }, { de: "Die Rechnung, bitte.", zh: "ËØ∑ÁªìË¥¶„ÄÇ" }, { de: "Kann ich mit Karte zahlen?", zh: "ÂèØ‰ª•Âà∑Âç°ÂêóÔºü" }], cafe: [{ de: "Einen Kaffee, bitte.", zh: "ËØ∑Êù•‰∏ÄÊùØÂíñÂï°„ÄÇ" }, { de: "Zum Mitnehmen, bitte.", zh: "ËØ∑ÊâìÂåÖÂ∏¶Ëµ∞„ÄÇ" }, { de: "F√ºr hier, bitte.", zh: "Âú®ËøôÈáåÂñù„ÄÇ" }], fastfood: [{ de: "Zum Mitnehmen oder hier essen?", zh: "Â∏¶Ëµ∞ËøòÊòØÂú®ËøôÂÑøÂêÉÔºü" }, { de: "Das ist alles.", zh: "Â∞±Ëøô‰∫õ‰∫Ü„ÄÇ" }], bar: [{ de: "Ein Bier, bitte.", zh: "ËØ∑Êù•‰∏ÄÊùØÂï§ÈÖí„ÄÇ" }, { de: "Prost!", zh: "Âπ≤ÊùØÔºÅ" }], bakery: [{ de: "Zwei Br√∂tchen, bitte.", zh: "ËØ∑Êù•‰∏§‰∏™Â∞èÈù¢ÂåÖ„ÄÇ" }, { de: "Das da, bitte.", zh: "ËØ∑ÁªôÊàëÈÇ£‰∏™„ÄÇ" }], transport: [{ de: "Wo ist die n√§chste U-Bahn?", zh: "ÊúÄËøëÁöÑÂú∞ÈìÅÁ´ôÂú®Âì™Ôºü" }, { de: "Muss ich umsteigen?", zh: "ÊàëÈúÄË¶ÅÊç¢‰πòÂêóÔºü" }], train: [{ de: "Wann f√§hrt der Zug ab?", zh: "ÁÅ´ËΩ¶‰ªÄ‰πàÊó∂ÂÄôÂèëËΩ¶Ôºü" }, { de: "Von welchem Gleis?", zh: "‰ªéÂì™‰∏™Á´ôÂè∞Ôºü" }], taxi: [{ de: "K√∂nnen Sie mich zum... bringen?", zh: "ËÉΩÈÄÅÊàëÂéª...ÂêóÔºü" }, { de: "Hier ist gut, danke.", zh: "ËøôÈáåÂÅúÂ∞±Â•ΩÔºåË∞¢Ë∞¢„ÄÇ" }], directions: [{ de: "Wie komme ich zum...?", zh: "ÊÄé‰πàÂéª...Ôºü" }, { de: "Ich habe mich verlaufen.", zh: "ÊàëËø∑Ë∑Ø‰∫Ü„ÄÇ" }], airport: [{ de: "Wo ist der Check-in?", zh: "ÂÄºÊú∫Âú®Âì™ÈáåÔºü" }, { de: "Welches Gate?", zh: "Âì™‰∏™ÁôªÊú∫Âè£Ôºü" }], car: [{ de: "Volltanken, bitte.", zh: "ËØ∑Âä†Êª°Ê≤π„ÄÇ" }], supermarket: [{ de: "Wo finde ich...?", zh: "...Âú®Âì™ÈáåÔºü" }, { de: "Das ist alles.", zh: "Â∞±Ëøô‰∫õ‰∫Ü„ÄÇ" }], clothing: [{ de: "Kann ich das anprobieren?", zh: "ÊàëÂèØ‰ª•ËØïÁ©øÂêóÔºü" }], electronics: [{ de: "Wie lange ist die Garantie?", zh: "‰øù‰øÆÂ§öÈïøÊó∂Èó¥Ôºü" }], returns: [{ de: "Ich m√∂chte das zur√ºckgeben.", zh: "ÊàëÊÉ≥ÈÄÄË¥ß„ÄÇ" }], greeting: [{ de: "Guten Tag!", zh: "‰Ω†Â•ΩÔºÅ" }, { de: "Wie geht's?", zh: "‰Ω†Â•ΩÂêóÔºü" }, { de: "Tsch√ºss!", zh: "ÂÜçËßÅÔºÅ" }], intro: [{ de: "Ich hei√üe...", zh: "ÊàëÂè´..." }, { de: "Ich komme aus China.", zh: "ÊàëÊù•Ëá™‰∏≠ÂõΩ„ÄÇ" }], neighbor: [{ de: "K√∂nnen Sie mir bitte helfen?", zh: "ÊÇ®ËÉΩÂ∏ÆÊàë‰∏Ä‰∏ãÂêóÔºü" }], thanks: [{ de: "Danke sch√∂n!", zh: "ÈùûÂ∏∏ÊÑüË∞¢ÔºÅ" }, { de: "Entschuldigung!", zh: "Êä±Ê≠âÔºÅ" }], weather: [{ de: "Sch√∂nes Wetter heute!", zh: "‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºÅ" }], doctor: [{ de: "Ich m√∂chte einen Termin.", zh: "ÊàëÊÉ≥È¢ÑÁ∫¶„ÄÇ" }, { de: "Ich habe Schmerzen hier.", zh: "ÊàëËøôÈáåÁóõ„ÄÇ" }], pharmacy: [{ de: "Ich brauche etwas gegen...", zh: "ÊàëÈúÄË¶ÅÊ≤ª...ÁöÑËçØ" }], dentist: [{ de: "Ich habe Zahnschmerzen.", zh: "ÊàëÁâôÁóõ„ÄÇ" }], housing: [{ de: "Ich suche eine Wohnung.", zh: "ÊàëÂú®ÊâæÊàøÂ≠ê„ÄÇ" }, { de: "Wie hoch ist die Miete?", zh: "ÊàøÁßüÂ§öÂ∞ëÔºü" }], repair: [{ de: "Die Heizung funktioniert nicht.", zh: "ÊöñÊ∞îÂùè‰∫Ü„ÄÇ" }], post: [{ de: "Ich m√∂chte das nach China schicken.", zh: "ÊàëÊÉ≥ÂØÑËøô‰∏™Âéª‰∏≠ÂõΩ„ÄÇ" }], bank: [{ de: "Ich m√∂chte ein Konto er√∂ffnen.", zh: "ÊàëÊÉ≥ÂºÄÊà∑„ÄÇ" }], haircut: [{ de: "Etwas k√ºrzer, bitte.", zh: "ËØ∑Ââ™Áü≠‰∏ÄÁÇπ„ÄÇ" }], gym: [{ de: "Ich m√∂chte mich anmelden.", zh: "ÊàëÊÉ≥ÂäûÂç°„ÄÇ" }], laundry: [{ de: "K√∂nnen Sie das reinigen?", zh: "ËÉΩÊ¥óËøô‰∏™ÂêóÔºü" }], cityhall: [{ de: "Ich m√∂chte mich anmelden.", zh: "ÊàëÊÉ≥ÁôªËÆ∞‰ΩèÂùÄ„ÄÇ" }], telecom: [{ de: "Ich m√∂chte eine SIM-Karte kaufen.", zh: "ÊàëÊÉ≥‰π∞‰∏ÄÂº†SIMÂç°„ÄÇ" }], office: [{ de: "Ich verstehe.", zh: "ÊàëÊòéÁôΩ‰∫Ü„ÄÇ" }, { de: "Einen Moment, bitte.", zh: "ËØ∑Á®çÁ≠â„ÄÇ" }], leave: [{ de: "Ich m√∂chte Urlaub beantragen.", zh: "ÊàëÊÉ≥ËØ∑ÂÅá„ÄÇ" }], interview: [{ de: "Ich habe mich f√ºr die Stelle beworben.", zh: "ÊàëÁî≥ËØ∑‰∫ÜËøô‰∏™ËÅå‰Ωç„ÄÇ" }], emergency: [{ de: "Hilfe!", zh: "ÊïëÂëΩÔºÅ" }, { de: "Rufen Sie die Polizei!", zh: "ËØ∑Êä•Ë≠¶ÔºÅ" }], complaint: [{ de: "Ich m√∂chte mich beschweren.", zh: "ÊàëÊÉ≥ÊäïËØâ„ÄÇ" }] } };
        const EMOJIS = ['üçΩÔ∏è', '‚òï', 'üçî', 'üç∫', 'ü•ê', 'üöá', 'üöÑ', 'üöï', 'üó∫Ô∏è', '‚úàÔ∏è', '‚õΩ', 'üõí', 'üëó', 'üì±', 'üì¶', 'üëã', 'üôã', 'üèòÔ∏è', 'üôè', 'üå§Ô∏è', 'üè•', 'üíä', 'ü¶∑', 'üè†', 'üîß', 'üìÆ', 'üè¶', 'üíá', 'üèãÔ∏è', 'üß∫', 'üèõÔ∏è', 'üì∂', 'üíº', 'üèñÔ∏è', 'ü§ù', 'üÜò', 'üì¢', 'üéì', 'üé≠', 'üéµ', 'üèÉ', 'üç≥', 'üõèÔ∏è', 'üöø', 'üìö', 'üíª', 'üéÆ', 'üåç', '‚ù§Ô∏è', '‚≠ê'];
        let categories = {};
        let phrases = {};
        let favorites = [];
        let currentPage = 'home';
        let currentScene = null;
        let currentCategoryKey = null;
        let lastAIResult = null;
        let longPressTimer = null;

        function loadData() {
            const saved = localStorage.getItem('germanAppData');
            if (saved) {
                const data = JSON.parse(saved);
                categories = data.categories || {};
                phrases = data.phrases || {};
            } else {
                categories = JSON.parse(JSON.stringify(DEFAULT_DATA.categories));
                phrases = JSON.parse(JSON.stringify(DEFAULT_DATA.phrases));
                saveData();
            }
            favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        }
        function saveData() { localStorage.setItem('germanAppData', JSON.stringify({ categories, phrases })); }
        function init() {
            loadData();
            renderCategories();
            renderFavorites();
            loadApiKey();
            document.getElementById('aiInput').addEventListener('keypress', e => { if (e.key === 'Enter') askAI(); });
            document.addEventListener('click', () => hideContextMenu());
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);
        }
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            for (const [sectionName, items] of Object.entries(categories)) {
                const section = document.createElement('div');
                section.className = 'category-section';
                section.innerHTML = `<div class="category-section-header"><h2>${sectionName}</h2></div><div class="category-grid">${items.map(item => `
            <div class="category-item">
                <div class="category-content" onclick="openScene('${item.id}','${item.emoji}','${item.name}','${sectionName}')">
                    <div class="emoji">${item.emoji}</div>
                    <div class="name">${item.name}</div>
                </div>
                <button class="more-btn" onclick="showSceneMenu(event,'${sectionName}','${item.id}')">‚ãÆ</button>
            </div>`).join('')}<div class="category-item add-btn" onclick="showAddSceneModal('${sectionName}')"><div class="emoji">‚ûï</div><div class="name">Ê∑ªÂä†</div></div></div>`;
                container.appendChild(section);
            }
        }
        function renderPhrases(sceneId) {
            const list = document.getElementById('phraseList');
            const scenePhrases = phrases[sceneId] || [];
            list.innerHTML = scenePhrases.map((p, i) => `
        <div class="phrase-card">
            <div class="german">${p.de}</div>
            <div class="chinese">${p.zh}</div>
            <button class="favorite-btn ${isFavorite(p.de) ? 'favorited' : ''}" onclick="toggleFavorite('${esc(p.de)}','${esc(p.zh)}',this)">${isFavorite(p.de) ? '‚≠ê' : '‚òÜ'}</button>
            <button class="more-btn" onclick="showPhraseMenu(event,${i})">‚ãÆ</button>
        </div>`).join('');
        }
        function renderFavorites() {
            const list = document.getElementById('favoritesList');
            const empty = document.getElementById('emptyFavorites');
            if (favorites.length === 0) { empty.style.display = 'block'; list.innerHTML = ''; return; }
            empty.style.display = 'none';
            list.innerHTML = favorites.map(p => `<div class="phrase-card"><div class="german">${p.de}</div><div class="chinese">${p.zh}</div><button class="favorite-btn favorited" onclick="toggleFavorite('${esc(p.de)}','${esc(p.zh)}',this)">‚≠ê</button></div>`).join('');
        }
        function showPage(pageName) {
            currentPage = pageName;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            const tabBtn = document.querySelector(`.tab-item[data-page="${pageName}"]`);
            if (tabBtn) tabBtn.classList.add('active');
            const backBtn = document.getElementById('backBtn');
            const title = document.getElementById('headerTitle');
            const rightBtn = document.getElementById('headerRightBtn');
            if (pageName === 'home') { backBtn.classList.add('hidden'); title.textContent = 'Âæ∑ËØ≠ÁîüÂ≠òÊâãÂÜå'; rightBtn.onclick = () => showPage('settings'); rightBtn.textContent = '‚öôÔ∏è'; rightBtn.classList.remove('hidden'); currentScene = null; }
            else if (pageName === 'scene') { backBtn.classList.remove('hidden'); rightBtn.textContent = 'ü§ñ'; rightBtn.classList.remove('hidden'); rightBtn.onclick = () => showAIGenerateModal(); }
            else if (pageName === 'favorites') { backBtn.classList.add('hidden'); title.textContent = 'ÊàëÁöÑÊî∂Ëóè'; rightBtn.classList.add('hidden'); renderFavorites(); }
            else if (pageName === 'settings') { backBtn.classList.remove('hidden'); title.textContent = 'ËÆæÁΩÆ'; rightBtn.classList.add('hidden'); }
        }
        function openScene(sceneId, emoji, name, categoryKey) {
            currentScene = sceneId; currentCategoryKey = categoryKey;
            document.getElementById('sceneHeader').querySelector('.emoji').textContent = emoji;
            document.getElementById('sceneHeader').querySelector('h2').textContent = name;
            document.getElementById('headerTitle').textContent = name;
            renderPhrases(sceneId);
            showPage('scene');
        }
        function goBack() { if (currentPage === 'scene' || currentPage === 'settings') showPage('home'); }
        function isFavorite(de) { return favorites.some(f => f.de === de); }
        function toggleFavorite(de, zh, btn) {
            const idx = favorites.findIndex(f => f.de === de);
            if (idx >= 0) { favorites.splice(idx, 1); btn.classList.remove('favorited'); btn.textContent = '‚òÜ'; showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè'); }
            else { favorites.push({ de, zh }); btn.classList.add('favorited'); btn.textContent = '‚≠ê'; showToast('Â∑≤Êî∂Ëóè'); }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            if (currentPage === 'favorites') renderFavorites();
        }
        function clearFavorites() { if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊî∂ËóèÂêóÔºü')) { favorites = []; localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavorites(); showToast('Â∑≤Ê∏ÖÈô§'); } }
        async function askAI() {
            const query = document.getElementById('aiInput').value.trim();
            if (!query) return;
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) { showToast('ËØ∑ÂÖàÈÖçÁΩÆ API Key'); showPage('settings'); return; }
            const btn = document.getElementById('aiSearchBtn');
            const loading = document.getElementById('aiLoading');
            const result = document.getElementById('aiResult');
            btn.disabled = true; loading.classList.add('visible'); result.classList.remove('visible');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `‰Ω†ÊòØÂæ∑ËØ≠Âè£ËØ≠Âä©Êâã„ÄÇÁî®Êà∑ÊÉ≥ËØ¥Ôºö${query}\nËØ∑ÂõûÂ§çÔºö\nÂæ∑ËØ≠Ôºö[Âæ∑ËØ≠Âè•Â≠ê]\n‰∏≠ÊñáÔºö[‰∏≠ÊñáÁøªËØë]\nÂ§áÊ≥®Ôºö[‰ΩøÁî®Âú∫ÊôØ]` }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const deMatch = text.match(/Âæ∑ËØ≠[Ôºö:]\s*(.+)/);
                const zhMatch = text.match(/‰∏≠Êñá[Ôºö:]\s*(.+)/);
                const noteMatch = text.match(/Â§áÊ≥®[Ôºö:]\s*(.+)/);
                if (deMatch && zhMatch) {
                    lastAIResult = { de: deMatch[1].trim(), zh: zhMatch[1].trim(), note: noteMatch ? noteMatch[1].trim() : '' };
                    document.getElementById('aiResultGerman').textContent = lastAIResult.de;
                    document.getElementById('aiResultChinese').textContent = lastAIResult.zh;
                    document.getElementById('aiResultNote').textContent = lastAIResult.note;
                    result.classList.add('visible');
                } else showToast('AIËøîÂõûÊ†ºÂºèÊúâËØØ');
            } catch (e) { showToast('Êü•ËØ¢Â§±Ë¥•'); console.error(e); }
            finally { btn.disabled = false; loading.classList.remove('visible'); }
        }
        function saveAIResult() { if (lastAIResult && !isFavorite(lastAIResult.de)) { favorites.push({ de: lastAIResult.de, zh: lastAIResult.zh }); localStorage.setItem('favorites', JSON.stringify(favorites)); showToast('Â∑≤Êî∂Ëóè'); } else showToast('Â∑≤Êî∂ËóèËøá‰∫Ü'); }
        function copyAIResult() { if (lastAIResult) { navigator.clipboard.writeText(lastAIResult.de).then(() => showToast('Â∑≤Â§çÂà∂')); } }
        function loadApiKey() { document.getElementById('apiKeyInput').value = localStorage.getItem('geminiApiKey') || ''; }
        function saveApiKey() { localStorage.setItem('geminiApiKey', document.getElementById('apiKeyInput').value.trim()); showToast('Â∑≤‰øùÂ≠ò'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); }
        function esc(s) { return s.replace(/'/g, "\\'").replace(/"/g, '\\"'); }
        // Modal
        function showModal(title, bodyHtml, footerHtml) { document.getElementById('modalTitle').textContent = title; document.getElementById('modalBody').innerHTML = bodyHtml; document.getElementById('modalFooter').innerHTML = footerHtml; document.getElementById('modalOverlay').classList.add('visible'); }
        function closeModal(e) { if (!e || e.target === document.getElementById('modalOverlay')) document.getElementById('modalOverlay').classList.remove('visible'); }
        // Context Menu
        function showContextMenu(x, y, items) {
            const menu = document.getElementById('contextMenu');
            menu.innerHTML = items.map(i => `<button class="${i.danger ? 'danger' : ''}" onclick="${i.action}">${i.icon} ${i.label}</button>`).join('');
            menu.style.left = Math.min(x, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 100) + 'px';
            menu.classList.add('visible');
        }
        function hideContextMenu() { document.getElementById('contextMenu').classList.remove('visible'); }
        function startLongPress(e, type, ...args) { longPressTimer = setTimeout(() => { e.preventDefault(); if (type === 'scene') showSceneMenu(e, args[0], args[1]); else if (type === 'phrase') showPhraseMenu(e, args[0]); }, 500); }
        function cancelLongPress() { clearTimeout(longPressTimer); }
        // Add Category
        function showAddCategoryModal() {
            showModal('Ê∑ªÂä†ÂàÜÁ±ª', `<div class="form-group"><label>ÂàÜÁ±ªÂêçÁß∞</label><input type="text" id="newCategoryName" placeholder="Â¶ÇÔºöÊóÖÊ∏∏Á±ª"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button><button class="btn btn-primary" onclick="addCategory()">Ê∑ªÂä†</button>`);
        }
        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) { showToast('ËØ∑ËæìÂÖ•ÂêçÁß∞'); return; }
            if (categories[name]) { showToast('ÂàÜÁ±ªÂ∑≤Â≠òÂú®'); return; }
            categories[name] = [];
            saveData(); renderCategories(); closeModal(); showToast('Â∑≤Ê∑ªÂä†');
        }
        // Add Scene
        function showAddSceneModal(categoryKey) {
            currentCategoryKey = categoryKey;
            showModal('Ê∑ªÂä†Âú∫ÊôØ', `<div class="form-group"><label>ÈÄâÊã©ÂõæÊ†á</label><div class="emoji-picker" id="emojiPicker">${EMOJIS.map(e => `<button type="button" onclick="selectEmoji('${e}')">${e}</button>`).join('')}</div></div><div class="form-group"><label>Âú∫ÊôØÂêçÁß∞</label><input type="text" id="newSceneName" placeholder="Â¶ÇÔºöÂíñÂï°ÂéÖ"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button><button class="btn btn-primary" onclick="addScene()">Ê∑ªÂä†</button>`);
        }
        function selectEmoji(emoji) { document.querySelectorAll('.emoji-picker button').forEach(b => b.classList.remove('selected')); event.target.classList.add('selected'); }
        function addScene() {
            const name = document.getElementById('newSceneName').value.trim();
            const emojiBtn = document.querySelector('.emoji-picker button.selected');
            const emoji = emojiBtn ? emojiBtn.textContent : 'üìù';
            if (!name) { showToast('ËØ∑ËæìÂÖ•ÂêçÁß∞'); return; }
            const id = 'scene_' + Date.now();
            categories[currentCategoryKey].push({ id, emoji, name });
            phrases[id] = [];
            saveData(); renderCategories(); closeModal(); showToast('Â∑≤Ê∑ªÂä†');
        }
        // Scene Menu
        function showSceneMenu(e, categoryKey, sceneId) {
            e.preventDefault();
            showContextMenu(e.clientX || e.touches?.[0]?.clientX || 100, e.clientY || e.touches?.[0]?.clientY || 100, [
                { icon: '‚úèÔ∏è', label: 'ÁºñËæë', action: `editScene('${categoryKey}','${sceneId}')` },
                { icon: 'üóëÔ∏è', label: 'Âà†Èô§', action: `deleteScene('${categoryKey}','${sceneId}')`, danger: true }
            ]);
        }
        function editScene(categoryKey, sceneId) {
            hideContextMenu();
            const scene = categories[categoryKey].find(s => s.id === sceneId);
            currentCategoryKey = categoryKey;
            showModal('ÁºñËæëÂú∫ÊôØ', `<div class="form-group"><label>ÈÄâÊã©ÂõæÊ†á</label><div class="emoji-picker">${EMOJIS.map(e => `<button type="button" class="${e === scene.emoji ? 'selected' : ''}" onclick="selectEmoji('${e}')">${e}</button>`).join('')}</div></div><div class="form-group"><label>Âú∫ÊôØÂêçÁß∞</label><input type="text" id="editSceneName" value="${scene.name}"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button><button class="btn btn-primary" onclick="saveEditScene('${sceneId}')">‰øùÂ≠ò</button>`);
        }
        function saveEditScene(sceneId) {
            const name = document.getElementById('editSceneName').value.trim();
            const emojiBtn = document.querySelector('.emoji-picker button.selected');
            const emoji = emojiBtn ? emojiBtn.textContent : 'üìù';
            if (!name) { showToast('ËØ∑ËæìÂÖ•ÂêçÁß∞'); return; }
            const scene = categories[currentCategoryKey].find(s => s.id === sceneId);
            scene.name = name; scene.emoji = emoji;
            saveData(); renderCategories(); closeModal(); showToast('Â∑≤‰øùÂ≠ò');
        }
        function deleteScene(categoryKey, sceneId) {
            hideContextMenu();
            if (confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Âú∫ÊôØÔºü')) {
                categories[categoryKey] = categories[categoryKey].filter(s => s.id !== sceneId);
                delete phrases[sceneId];
                saveData(); renderCategories(); showToast('Â∑≤Âà†Èô§');
            }
        }
        // Add Phrase
        function showAddPhraseModal() {
            showModal('Ê∑ªÂä†Áü≠Âè•', `<div class="form-group"><label>Âæ∑ËØ≠</label><input type="text" id="newPhraseDE" placeholder="Âæ∑ËØ≠Áü≠Âè•"></div><div class="form-group"><label>‰∏≠Êñá</label><input type="text" id="newPhraseZH" placeholder="‰∏≠ÊñáÁøªËØë"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button><button class="btn btn-primary" onclick="addPhrase()">Ê∑ªÂä†</button>`);
        }
        function addPhrase() {
            const de = document.getElementById('newPhraseDE').value.trim();
            const zh = document.getElementById('newPhraseZH').value.trim();
            if (!de || !zh) { showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥'); return; }
            if (!phrases[currentScene]) phrases[currentScene] = [];
            phrases[currentScene].push({ de, zh });
            saveData(); renderPhrases(currentScene); closeModal(); showToast('Â∑≤Ê∑ªÂä†');
        }
        // Phrase Menu
        function showPhraseMenu(e, idx) {
            e.preventDefault();
            showContextMenu(e.clientX || e.touches?.[0]?.clientX || 100, e.clientY || e.touches?.[0]?.clientY || 100, [
                { icon: '‚úèÔ∏è', label: 'ÁºñËæë', action: `editPhrase(${idx})` },
                { icon: 'üóëÔ∏è', label: 'Âà†Èô§', action: `deletePhrase(${idx})`, danger: true }
            ]);
        }
        function editPhrase(idx) {
            hideContextMenu();
            const p = phrases[currentScene][idx];
            showModal('ÁºñËæëÁü≠Âè•', `<div class="form-group"><label>Âæ∑ËØ≠</label><input type="text" id="editPhraseDE" value="${p.de}"></div><div class="form-group"><label>‰∏≠Êñá</label><input type="text" id="editPhraseZH" value="${p.zh}"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button><button class="btn btn-primary" onclick="saveEditPhrase(${idx})">‰øùÂ≠ò</button>`);
        }
        function saveEditPhrase(idx) {
            const de = document.getElementById('editPhraseDE').value.trim();
            const zh = document.getElementById('editPhraseZH').value.trim();
            if (!de || !zh) { showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥'); return; }
            phrases[currentScene][idx] = { de, zh };
            saveData(); renderPhrases(currentScene); closeModal(); showToast('Â∑≤‰øùÂ≠ò');
        }
        function deletePhrase(idx) { hideContextMenu(); if (confirm('Á°ÆÂÆöÂà†Èô§Ôºü')) { phrases[currentScene].splice(idx, 1); saveData(); renderPhrases(currentScene); showToast('Â∑≤Âà†Èô§'); } }
        // AI Generate
        function showAIGenerateModal() {
            showModal('AI ÁîüÊàêÁü≠Âè•', `<div class="form-group"><label>Âæ∑ËØ≠ÈöæÂ∫¶</label><div class="level-selector"><button class="level-btn selected" onclick="selectLevel(this)">A1</button><button class="level-btn" onclick="selectLevel(this)">A2</button><button class="level-btn" onclick="selectLevel(this)">B1</button></div></div><div class="form-group"><label>ÁîüÊàêÊï∞Èáè</label><select id="aiGenCount"><option value="5">5‰∏™</option><option value="10" selected>10‰∏™</option><option value="15">15‰∏™</option></select></div><button class="btn btn-primary" style="width:100%" onclick="generatePhrases()">ü§ñ ÁîüÊàêÁü≠Âè•</button><div class="ai-loading" id="genLoading"><div class="spinner"></div><span>ÁîüÊàê‰∏≠...</span></div><div class="generated-phrases" id="generatedPhrases"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">ÂÖ≥Èó≠</button><button class="btn btn-primary" id="addGenBtn" style="display:none" onclick="addGeneratedPhrases()">Ê∑ªÂä†ÈÄâ‰∏≠</button>`);
        }
        function selectLevel(btn) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        async function generatePhrases() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) { showToast('ËØ∑ÂÖàÈÖçÁΩÆ API Key'); return; }
            const level = document.querySelector('.level-btn.selected').textContent;
            const count = document.getElementById('aiGenCount').value;
            const sceneName = document.getElementById('sceneHeader').querySelector('h2').textContent;
            const loading = document.getElementById('genLoading');
            const container = document.getElementById('generatedPhrases');
            loading.classList.add('visible'); container.innerHTML = '';
            const currentPhrases = (phrases[currentScene] || []).map(p => p.de).join(', ');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `ÁîüÊàê${count}‰∏™ÂÖ≥‰∫é"${sceneName}"Âú∫ÊôØÁöÑÂæ∑ËØ≠${level}Ê∞¥Âπ≥Êó•Â∏∏Âè£ËØ≠Áü≠Âè•„ÄÇ
Â∑≤ÊúâÁü≠Âè•ÔºàËØ∑ÁªùÂØπ‰∏çË¶ÅÈáçÂ§ç‰ª•‰∏ãÂÜÖÂÆπÔºâÔºö${currentPhrases}
Ê†ºÂºèÔºöÊØèË°å‰∏Ä‰∏™ÔºåÁî®|ÂàÜÈöîÂæ∑ËØ≠Âíå‰∏≠Êñá„ÄÇ‰æãÂ¶ÇÔºöGuten Tag!|‰Ω†Â•ΩÔºÅ
Âè™ËæìÂá∫Áü≠Âè•Ôºå‰∏çË¶ÅÂÖ∂‰ªñÂÜÖÂÆπ„ÄÇ` }]
                        }]
                    })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const lines = text.split('\n').filter(l => l.includes('|'));
                if (lines.length === 0) { showToast('ÁîüÊàêÂ§±Ë¥•'); return; }
                container.innerHTML = lines.map((l, i) => {
                    const [de, zh] = l.split('|').map(s => s.trim());
                    return `<div class="generated-phrase"><input type="checkbox" checked id="gen${i}"><div class="generated-phrase-content"><div class="de">${de}</div><div class="zh">${zh}</div></div></div>`;
                }).join('');
                document.getElementById('addGenBtn').style.display = 'block';
            } catch (e) { showToast('ÁîüÊàêÂ§±Ë¥•'); console.error(e); }
            finally { loading.classList.remove('visible'); }
        }
        function addGeneratedPhrases() {
            const items = document.querySelectorAll('.generated-phrase');
            let added = 0;
            items.forEach((item, i) => {
                if (item.querySelector('input').checked) {
                    const de = item.querySelector('.de').textContent;
                    const zh = item.querySelector('.zh').textContent;
                    if (!phrases[currentScene]) phrases[currentScene] = [];
                    phrases[currentScene].push({ de, zh });
                    added++;
                }
            });
            saveData(); renderPhrases(currentScene); closeModal(); showToast(`Â∑≤Ê∑ªÂä†${added}‰∏™Áü≠Âè•`);
        }
        // Export/Import
        function exportData() {
            const data = { categories, phrases, favorites };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'german-survival-backup.json';
            a.click();
            showToast('Â∑≤ÂØºÂá∫');
        }
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.categories) categories = data.categories;
                    if (data.phrases) phrases = data.phrases;
                    if (data.favorites) favorites = data.favorites;
                    saveData();
                    localStorage.setItem('favorites', JSON.stringify(favorites));
                    renderCategories(); renderFavorites();
                    showToast('Â∑≤ÂØºÂÖ•');
                } catch (err) { showToast('ÂØºÂÖ•Â§±Ë¥•'); }
            };
            reader.readAsText(file);
        }
        function resetToDefault() {
            if (confirm('Á°ÆÂÆöÊÅ¢Â§çÈªòËÆ§Êï∞ÊçÆÔºüËá™ÂÆö‰πâÂÜÖÂÆπÂ∞Ü‰∏¢Â§±„ÄÇ')) {
                categories = JSON.parse(JSON.stringify(DEFAULT_DATA.categories));
                phrases = JSON.parse(JSON.stringify(DEFAULT_DATA.phrases));
                saveData(); renderCategories(); showToast('Â∑≤ÊÅ¢Â§ç');
            }
        }
        init();
    </script>
</body>

</html>