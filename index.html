<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å¾·è¯­ç”Ÿå­˜">
    <meta name="theme-color" content="#007AFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1C1C1E" media="(prefers-color-scheme: dark)">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>å¾·è¯­ç”Ÿå­˜æ‰‹å†Œ</title>
    <style>
        :root {
            --bg-primary: #F5F5F7;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #E5E5EA;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --accent-light: rgba(0, 122, 255, 0.1);
            --border: rgba(0, 0, 0, 0.1);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --danger: #FF3B30;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1C1C1E;
                --bg-secondary: #2C2C2E;
                --bg-tertiary: #3A3A3C;
                --text-primary: #FFFFFF;
                --text-secondary: #8E8E93;
                --accent: #0A84FF;
                --accent-light: rgba(10, 132, 255, 0.15);
                --border: rgba(255, 255, 255, 0.1);
                --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: calc(var(--safe-top) + 12px) 16px 12px;
            border-bottom: 1px solid var(--border);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
        }

        .header-btn.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .content {
            flex: 1;
            padding: 16px;
            padding-bottom: calc(80px + var(--safe-bottom));
            overflow-y: auto;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 0 calc(8px + var(--safe-bottom));
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .tab-item.active {
            color: var(--accent);
        }

        .tab-item .icon {
            font-size: 24px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .category-section {
            margin-bottom: 24px;
        }

        .category-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .category-section-header h2 {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .category-item {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px 8px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            border: none;
            color: var(--text-primary);
            position: relative;
        }

        .category-item:active {
            transform: scale(0.95);
        }

        .category-item .emoji {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .category-item .name {
            font-size: 12px;
            font-weight: 500;
            line-height: 1.3;
        }

        .category-item.add-btn {
            background: var(--accent-light);
            border: 2px dashed var(--accent);
        }

        .category-item.add-btn .emoji {
            color: var(--accent);
        }

        .add-category-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-light);
            border: 2px dashed var(--accent);
            border-radius: 16px;
            color: var(--accent);
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }

        .phrase-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .phrase-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--card-shadow);
            position: relative;
        }

        .phrase-card .german {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
            padding-right: 40px;
        }

        .phrase-card .chinese {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .phrase-card .favorite-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phrase-card .favorite-btn.favorited {
            background: var(--accent-light);
        }

        .add-phrase-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-light);
            border: 2px dashed var(--accent);
            border-radius: 16px;
            color: var(--accent);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .ai-section {
            margin-bottom: 24px;
        }

        .search-box {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--card-shadow);
        }

        .search-box h3 {
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        .search-btn {
            padding: 12px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .search-btn:disabled {
            opacity: 0.5;
        }

        .ai-result {
            margin-top: 16px;
            padding: 16px;
            background: var(--accent-light);
            border-radius: 12px;
            display: none;
        }

        .ai-result.visible {
            display: block;
        }

        .ai-result .german {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .ai-result .chinese {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .ai-result .note {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .ai-result-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .ai-result-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
        }

        .ai-result-btn.save {
            background: var(--accent);
            color: white;
        }

        .ai-result-btn.copy {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .ai-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            color: var(--text-secondary);
        }

        .ai-loading.visible {
            display: flex;
        }

        .ai-loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .settings-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .settings-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item label {
            font-size: 16px;
        }

        .settings-item input[type="password"],
        .settings-item input[type="text"] {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .settings-item button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .settings-item .save-btn {
            background: var(--accent);
            color: white;
        }

        .settings-item .danger-btn {
            background: var(--danger);
            color: white;
        }

        .settings-note {
            padding: 12px 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .settings-note a {
            color: var(--accent);
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .scene-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .scene-header .emoji {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .scene-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-group input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-picker button {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
        }

        .emoji-picker button.selected {
            background: var(--accent-light);
            border: 2px solid var(--accent);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 300;
            min-width: 150px;
            overflow: hidden;
            display: none;
        }

        .context-menu.visible {
            display: block;
        }

        .context-menu button {
            width: 100%;
            padding: 14px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .context-menu button:active {
            background: var(--bg-tertiary);
        }

        .context-menu button.danger {
            color: var(--danger);
        }

        /* AI Generate */
        .level-selector {
            display: flex;
            gap: 8px;
        }

        .level-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            text-align: center;
        }

        .level-btn.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            color: var(--accent);
        }

        .generated-phrases {
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .generated-phrase {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .generated-phrase input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 4px;
        }

        .generated-phrase-content {
            flex: 1;
        }

        .generated-phrase .de {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .generated-phrase .zh {
            font-size: 14px;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="header">
            <button class="header-btn hidden" id="backBtn" onclick="goBack()">â†</button>
            <h1 id="headerTitle">å¾·è¯­ç”Ÿå­˜æ‰‹å†Œ</h1>
            <button class="header-btn" id="headerRightBtn" onclick="showPage('settings')">âš™ï¸</button>
        </header>
        <main class="content">
            <div class="page active" id="page-home">
                <div class="ai-section">
                    <div class="search-box">
                        <h3>ğŸ¤– é—® AI</h3>
                        <div class="search-input-wrapper">
                            <input type="text" class="search-input" id="aiInput" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„ä¸­æ–‡...">
                            <button class="search-btn" id="aiSearchBtn" onclick="askAI()">æŸ¥è¯¢</button>
                        </div>
                        <div class="ai-loading" id="aiLoading">
                            <div class="spinner"></div><span>æ€è€ƒä¸­...</span>
                        </div>
                        <div class="ai-result" id="aiResult">
                            <div class="german" id="aiResultGerman"></div>
                            <div class="chinese" id="aiResultChinese"></div>
                            <div class="note" id="aiResultNote"></div>
                            <div class="ai-result-actions">
                                <button class="ai-result-btn save" onclick="saveAIResult()">â­ æ”¶è—</button>
                                <button class="ai-result-btn copy" onclick="copyAIResult()">ğŸ“‹ å¤åˆ¶</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="categoriesContainer"></div>
                <button class="add-category-btn" onclick="showAddCategoryModal()">â• æ·»åŠ æ–°åˆ†ç±»</button>
            </div>
            <div class="page" id="page-scene">
                <div class="scene-header" id="sceneHeader">
                    <div class="emoji"></div>
                    <h2></h2>
                </div>
                <div class="phrase-list" id="phraseList"></div>
                <button class="add-phrase-btn" onclick="showAddPhraseModal()">â• æ·»åŠ çŸ­å¥</button>
            </div>
            <div class="page" id="page-favorites">
                <div class="empty-state" id="emptyFavorites">
                    <div class="icon">â­</div>
                    <h3>æš‚æ— æ”¶è—</h3>
                    <p>ç‚¹å‡»çŸ­å¥å¡ç‰‡ä¸Šçš„æ˜Ÿæ˜Ÿæ¥æ”¶è—</p>
                </div>
                <div class="phrase-list" id="favoritesList"></div>
            </div>
            <div class="page" id="page-settings">
                <div class="settings-section">
                    <div class="settings-item"><label>API Key</label><input type="password" id="apiKeyInput"
                            placeholder="è¾“å…¥ Gemini API Key"><button class="save-btn" onclick="saveApiKey()">ä¿å­˜</button>
                    </div>
                </div>
                <div class="settings-note">AI åŠŸèƒ½éœ€è¦ Gemini API Keyã€‚<a href="https://aistudio.google.com/app/apikey"
                        target="_blank">è·å– API Key</a></div>
                <div class="settings-section">
                    <div class="settings-item"><label>å¯¼å‡ºæ•°æ®</label><button class="save-btn"
                            onclick="exportData()">å¯¼å‡º</button></div>
                    <div class="settings-item"><label>å¯¼å…¥æ•°æ®</label><input type="file" id="importFile" accept=".json"
                            onchange="importData(event)" style="display:none"><button class="save-btn"
                            onclick="document.getElementById('importFile').click()">å¯¼å…¥</button></div>
                    <div class="settings-item"><label>æ¢å¤é»˜è®¤æ•°æ®</label><button class="danger-btn"
                            onclick="resetToDefault()">æ¢å¤</button></div>
                    <div class="settings-item"><label>æ¸…é™¤æ‰€æœ‰æ”¶è—</label><button class="danger-btn"
                            onclick="clearFavorites()">æ¸…é™¤</button></div>
                </div>
            </div>
        </main>
        <nav class="tab-bar">
            <button class="tab-item active" onclick="showPage('home')" data-page="home"><span
                    class="icon">ğŸ </span><span>åœºæ™¯</span></button>
            <button class="tab-item" onclick="showPage('favorites')" data-page="favorites"><span
                    class="icon">â­</span><span>æ”¶è—</span></button>
        </nav>
        <div class="toast" id="toast"></div>
    </div>
    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">æ ‡é¢˜</h3><button class="modal-close" onclick="closeModal()">âœ•</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>
    <div class="context-menu" id="contextMenu"></div>
    <script>
        const DEFAULT_DATA = { categories: { "é¤é¥®ç±»": [{ id: "restaurant", emoji: "ğŸ½ï¸", name: "é¤å…ç‚¹é¤" }, { id: "cafe", emoji: "â˜•", name: "å’–å•¡å…" }, { id: "fastfood", emoji: "ğŸ”", name: "å¿«é¤å¤–å–" }, { id: "bar", emoji: "ğŸº", name: "é…’å§å¤œåº—" }, { id: "bakery", emoji: "ğŸ¥", name: "é¢åŒ…åº—" }], "å‡ºè¡Œç±»": [{ id: "transport", emoji: "ğŸš‡", name: "å…¬å…±äº¤é€š" }, { id: "train", emoji: "ğŸš„", name: "ç«è½¦é•¿é€”" }, { id: "taxi", emoji: "ğŸš•", name: "æ‰“è½¦ç§Ÿè½¦" }, { id: "directions", emoji: "ğŸ—ºï¸", name: "é—®è·¯æŒ‡è·¯" }, { id: "airport", emoji: "âœˆï¸", name: "æœºåœºç™»æœº" }, { id: "car", emoji: "â›½", name: "åŠ æ²¹ä¿®è½¦" }], "è´­ç‰©ç±»": [{ id: "supermarket", emoji: "ğŸ›’", name: "è¶…å¸‚è´­ç‰©" }, { id: "clothing", emoji: "ğŸ‘—", name: "æœè£…åº—" }, { id: "electronics", emoji: "ğŸ“±", name: "ç”µå™¨åº—" }, { id: "returns", emoji: "ğŸ“¦", name: "ç½‘è´­é€€è´§" }], "ç¤¾äº¤ç±»": [{ id: "greeting", emoji: "ğŸ‘‹", name: "æ—¥å¸¸é—®å€™" }, { id: "intro", emoji: "ğŸ™‹", name: "è‡ªæˆ‘ä»‹ç»" }, { id: "neighbor", emoji: "ğŸ˜ï¸", name: "é‚»å±…äº¤æµ" }, { id: "thanks", emoji: "ğŸ™", name: "é“æ­‰æ„Ÿè°¢" }, { id: "weather", emoji: "ğŸŒ¤ï¸", name: "å¤©æ°”é—²èŠ" }], "åŒ»ç–—ç±»": [{ id: "doctor", emoji: "ğŸ¥", name: "çœ‹ç—…å°±åŒ»" }, { id: "pharmacy", emoji: "ğŸ’Š", name: "è¯åº—ä¹°è¯" }, { id: "dentist", emoji: "ğŸ¦·", name: "ç‰™åŒ»çœ¼ç§‘" }], "ç”Ÿæ´»ç±»": [{ id: "housing", emoji: "ğŸ ", name: "ç§Ÿæˆ¿æ‰¾æˆ¿" }, { id: "repair", emoji: "ğŸ”§", name: "æŠ¥ä¿®ç»´æŠ¤" }, { id: "post", emoji: "ğŸ“®", name: "é‚®å±€å¿«é€’" }, { id: "bank", emoji: "ğŸ¦", name: "é“¶è¡Œä¸šåŠ¡" }, { id: "haircut", emoji: "ğŸ’‡", name: "ç†å‘ç¾å®¹" }, { id: "gym", emoji: "ğŸ‹ï¸", name: "å¥èº«æˆ¿" }, { id: "laundry", emoji: "ğŸ§º", name: "æ´—è¡£åº—" }], "åŠäº‹ç±»": [{ id: "cityhall", emoji: "ğŸ›ï¸", name: "å¸‚æ”¿å…" }, { id: "telecom", emoji: "ğŸ“¶", name: "ç”µä¿¡è¿è¥å•†" }], "å·¥ä½œç±»": [{ id: "office", emoji: "ğŸ’¼", name: "èŒåœºæ²Ÿé€š" }, { id: "leave", emoji: "ğŸ–ï¸", name: "è¯·å‡ä¼‘å‡" }, { id: "interview", emoji: "ğŸ¤", name: "é¢è¯•æ±‚èŒ" }], "ç´§æ€¥ç±»": [{ id: "emergency", emoji: "ğŸ†˜", name: "æŠ¥è­¦æ±‚åŠ©" }, { id: "complaint", emoji: "ğŸ“¢", name: "æŠ•è¯‰ç»´æƒ" }] }, phrases: { restaurant: [{ de: "Ich hÃ¤tte gerne...", zh: "æˆ‘æƒ³è¦..." }, { de: "Die Speisekarte, bitte.", zh: "è¯·ç»™æˆ‘èœå•ã€‚" }, { de: "Was empfehlen Sie?", zh: "æ‚¨æ¨èä»€ä¹ˆï¼Ÿ" }, { de: "Die Rechnung, bitte.", zh: "è¯·ç»“è´¦ã€‚" }, { de: "Kann ich mit Karte zahlen?", zh: "å¯ä»¥åˆ·å¡å—ï¼Ÿ" }], cafe: [{ de: "Einen Kaffee, bitte.", zh: "è¯·æ¥ä¸€æ¯å’–å•¡ã€‚" }, { de: "Zum Mitnehmen, bitte.", zh: "è¯·æ‰“åŒ…å¸¦èµ°ã€‚" }, { de: "FÃ¼r hier, bitte.", zh: "åœ¨è¿™é‡Œå–ã€‚" }], fastfood: [{ de: "Zum Mitnehmen oder hier essen?", zh: "å¸¦èµ°è¿˜æ˜¯åœ¨è¿™å„¿åƒï¼Ÿ" }, { de: "Das ist alles.", zh: "å°±è¿™äº›äº†ã€‚" }], bar: [{ de: "Ein Bier, bitte.", zh: "è¯·æ¥ä¸€æ¯å•¤é…’ã€‚" }, { de: "Prost!", zh: "å¹²æ¯ï¼" }], bakery: [{ de: "Zwei BrÃ¶tchen, bitte.", zh: "è¯·æ¥ä¸¤ä¸ªå°é¢åŒ…ã€‚" }, { de: "Das da, bitte.", zh: "è¯·ç»™æˆ‘é‚£ä¸ªã€‚" }], transport: [{ de: "Wo ist die nÃ¤chste U-Bahn?", zh: "æœ€è¿‘çš„åœ°é“ç«™åœ¨å“ªï¼Ÿ" }, { de: "Muss ich umsteigen?", zh: "æˆ‘éœ€è¦æ¢ä¹˜å—ï¼Ÿ" }], train: [{ de: "Wann fÃ¤hrt der Zug ab?", zh: "ç«è½¦ä»€ä¹ˆæ—¶å€™å‘è½¦ï¼Ÿ" }, { de: "Von welchem Gleis?", zh: "ä»å“ªä¸ªç«™å°ï¼Ÿ" }], taxi: [{ de: "KÃ¶nnen Sie mich zum... bringen?", zh: "èƒ½é€æˆ‘å»...å—ï¼Ÿ" }, { de: "Hier ist gut, danke.", zh: "è¿™é‡Œåœå°±å¥½ï¼Œè°¢è°¢ã€‚" }], directions: [{ de: "Wie komme ich zum...?", zh: "æ€ä¹ˆå»...ï¼Ÿ" }, { de: "Ich habe mich verlaufen.", zh: "æˆ‘è¿·è·¯äº†ã€‚" }], airport: [{ de: "Wo ist der Check-in?", zh: "å€¼æœºåœ¨å“ªé‡Œï¼Ÿ" }, { de: "Welches Gate?", zh: "å“ªä¸ªç™»æœºå£ï¼Ÿ" }], car: [{ de: "Volltanken, bitte.", zh: "è¯·åŠ æ»¡æ²¹ã€‚" }], supermarket: [{ de: "Wo finde ich...?", zh: "...åœ¨å“ªé‡Œï¼Ÿ" }, { de: "Das ist alles.", zh: "å°±è¿™äº›äº†ã€‚" }], clothing: [{ de: "Kann ich das anprobieren?", zh: "æˆ‘å¯ä»¥è¯•ç©¿å—ï¼Ÿ" }], electronics: [{ de: "Wie lange ist die Garantie?", zh: "ä¿ä¿®å¤šé•¿æ—¶é—´ï¼Ÿ" }], returns: [{ de: "Ich mÃ¶chte das zurÃ¼ckgeben.", zh: "æˆ‘æƒ³é€€è´§ã€‚" }], greeting: [{ de: "Guten Tag!", zh: "ä½ å¥½ï¼" }, { de: "Wie geht's?", zh: "ä½ å¥½å—ï¼Ÿ" }, { de: "TschÃ¼ss!", zh: "å†è§ï¼" }], intro: [{ de: "Ich heiÃŸe...", zh: "æˆ‘å«..." }, { de: "Ich komme aus China.", zh: "æˆ‘æ¥è‡ªä¸­å›½ã€‚" }], neighbor: [{ de: "KÃ¶nnen Sie mir bitte helfen?", zh: "æ‚¨èƒ½å¸®æˆ‘ä¸€ä¸‹å—ï¼Ÿ" }], thanks: [{ de: "Danke schÃ¶n!", zh: "éå¸¸æ„Ÿè°¢ï¼" }, { de: "Entschuldigung!", zh: "æŠ±æ­‰ï¼" }], weather: [{ de: "SchÃ¶nes Wetter heute!", zh: "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼" }], doctor: [{ de: "Ich mÃ¶chte einen Termin.", zh: "æˆ‘æƒ³é¢„çº¦ã€‚" }, { de: "Ich habe Schmerzen hier.", zh: "æˆ‘è¿™é‡Œç—›ã€‚" }], pharmacy: [{ de: "Ich brauche etwas gegen...", zh: "æˆ‘éœ€è¦æ²»...çš„è¯" }], dentist: [{ de: "Ich habe Zahnschmerzen.", zh: "æˆ‘ç‰™ç—›ã€‚" }], housing: [{ de: "Ich suche eine Wohnung.", zh: "æˆ‘åœ¨æ‰¾æˆ¿å­ã€‚" }, { de: "Wie hoch ist die Miete?", zh: "æˆ¿ç§Ÿå¤šå°‘ï¼Ÿ" }], repair: [{ de: "Die Heizung funktioniert nicht.", zh: "æš–æ°”åäº†ã€‚" }], post: [{ de: "Ich mÃ¶chte das nach China schicken.", zh: "æˆ‘æƒ³å¯„è¿™ä¸ªå»ä¸­å›½ã€‚" }], bank: [{ de: "Ich mÃ¶chte ein Konto erÃ¶ffnen.", zh: "æˆ‘æƒ³å¼€æˆ·ã€‚" }], haircut: [{ de: "Etwas kÃ¼rzer, bitte.", zh: "è¯·å‰ªçŸ­ä¸€ç‚¹ã€‚" }], gym: [{ de: "Ich mÃ¶chte mich anmelden.", zh: "æˆ‘æƒ³åŠå¡ã€‚" }], laundry: [{ de: "KÃ¶nnen Sie das reinigen?", zh: "èƒ½æ´—è¿™ä¸ªå—ï¼Ÿ" }], cityhall: [{ de: "Ich mÃ¶chte mich anmelden.", zh: "æˆ‘æƒ³ç™»è®°ä½å€ã€‚" }], telecom: [{ de: "Ich mÃ¶chte eine SIM-Karte kaufen.", zh: "æˆ‘æƒ³ä¹°ä¸€å¼ SIMå¡ã€‚" }], office: [{ de: "Ich verstehe.", zh: "æˆ‘æ˜ç™½äº†ã€‚" }, { de: "Einen Moment, bitte.", zh: "è¯·ç¨ç­‰ã€‚" }], leave: [{ de: "Ich mÃ¶chte Urlaub beantragen.", zh: "æˆ‘æƒ³è¯·å‡ã€‚" }], interview: [{ de: "Ich habe mich fÃ¼r die Stelle beworben.", zh: "æˆ‘ç”³è¯·äº†è¿™ä¸ªèŒä½ã€‚" }], emergency: [{ de: "Hilfe!", zh: "æ•‘å‘½ï¼" }, { de: "Rufen Sie die Polizei!", zh: "è¯·æŠ¥è­¦ï¼" }], complaint: [{ de: "Ich mÃ¶chte mich beschweren.", zh: "æˆ‘æƒ³æŠ•è¯‰ã€‚" }] } };
        const EMOJIS = ['ğŸ½ï¸', 'â˜•', 'ğŸ”', 'ğŸº', 'ğŸ¥', 'ğŸš‡', 'ğŸš„', 'ğŸš•', 'ğŸ—ºï¸', 'âœˆï¸', 'â›½', 'ğŸ›’', 'ğŸ‘—', 'ğŸ“±', 'ğŸ“¦', 'ğŸ‘‹', 'ğŸ™‹', 'ğŸ˜ï¸', 'ğŸ™', 'ğŸŒ¤ï¸', 'ğŸ¥', 'ğŸ’Š', 'ğŸ¦·', 'ğŸ ', 'ğŸ”§', 'ğŸ“®', 'ğŸ¦', 'ğŸ’‡', 'ğŸ‹ï¸', 'ğŸ§º', 'ğŸ›ï¸', 'ğŸ“¶', 'ğŸ’¼', 'ğŸ–ï¸', 'ğŸ¤', 'ğŸ†˜', 'ğŸ“¢', 'ğŸ“', 'ğŸ­', 'ğŸµ', 'ğŸƒ', 'ğŸ³', 'ğŸ›ï¸', 'ğŸš¿', 'ğŸ“š', 'ğŸ’»', 'ğŸ®', 'ğŸŒ', 'â¤ï¸', 'â­'];
        let categories = {};
        let phrases = {};
        let favorites = [];
        let currentPage = 'home';
        let currentScene = null;
        let currentCategoryKey = null;
        let lastAIResult = null;
        let longPressTimer = null;

        function loadData() {
            const saved = localStorage.getItem('germanAppData');
            if (saved) {
                const data = JSON.parse(saved);
                categories = data.categories || {};
                phrases = data.phrases || {};
            } else {
                categories = JSON.parse(JSON.stringify(DEFAULT_DATA.categories));
                phrases = JSON.parse(JSON.stringify(DEFAULT_DATA.phrases));
                saveData();
            }
            favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        }
        function saveData() { localStorage.setItem('germanAppData', JSON.stringify({ categories, phrases })); }
        function init() {
            loadData();
            renderCategories();
            renderFavorites();
            loadApiKey();
            document.getElementById('aiInput').addEventListener('keypress', e => { if (e.key === 'Enter') askAI(); });
            document.addEventListener('click', () => hideContextMenu());
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);
        }
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            for (const [sectionName, items] of Object.entries(categories)) {
                const section = document.createElement('div');
                section.className = 'category-section';
                section.innerHTML = `<div class="category-section-header"><h2>${sectionName}</h2></div><div class="category-grid">${items.map(item => `<button class="category-item" onclick="openScene('${item.id}','${item.emoji}','${item.name}','${sectionName}')" oncontextmenu="showSceneMenu(event,'${sectionName}','${item.id}')" ontouchstart="startLongPress(event,'scene','${sectionName}','${item.id}')" ontouchend="cancelLongPress()"><div class="emoji">${item.emoji}</div><div class="name">${item.name}</div></button>`).join('')}<button class="category-item add-btn" onclick="showAddSceneModal('${sectionName}')"><div class="emoji">â•</div><div class="name">æ·»åŠ </div></button></div>`;
                container.appendChild(section);
            }
        }
        function renderPhrases(sceneId) {
            const list = document.getElementById('phraseList');
            const scenePhrases = phrases[sceneId] || [];
            list.innerHTML = scenePhrases.map((p, i) => `<div class="phrase-card" oncontextmenu="showPhraseMenu(event,${i})" ontouchstart="startLongPress(event,'phrase',${i})" ontouchend="cancelLongPress()"><div class="german">${p.de}</div><div class="chinese">${p.zh}</div><button class="favorite-btn ${isFavorite(p.de) ? 'favorited' : ''}" onclick="toggleFavorite('${esc(p.de)}','${esc(p.zh)}',this)">${isFavorite(p.de) ? 'â­' : 'â˜†'}</button></div>`).join('');
        }
        function renderFavorites() {
            const list = document.getElementById('favoritesList');
            const empty = document.getElementById('emptyFavorites');
            if (favorites.length === 0) { empty.style.display = 'block'; list.innerHTML = ''; return; }
            empty.style.display = 'none';
            list.innerHTML = favorites.map(p => `<div class="phrase-card"><div class="german">${p.de}</div><div class="chinese">${p.zh}</div><button class="favorite-btn favorited" onclick="toggleFavorite('${esc(p.de)}','${esc(p.zh)}',this)">â­</button></div>`).join('');
        }
        function showPage(pageName) {
            currentPage = pageName;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            const tabBtn = document.querySelector(`.tab-item[data-page="${pageName}"]`);
            if (tabBtn) tabBtn.classList.add('active');
            const backBtn = document.getElementById('backBtn');
            const title = document.getElementById('headerTitle');
            const rightBtn = document.getElementById('headerRightBtn');
            if (pageName === 'home') { backBtn.classList.add('hidden'); title.textContent = 'å¾·è¯­ç”Ÿå­˜æ‰‹å†Œ'; rightBtn.onclick = () => showPage('settings'); rightBtn.textContent = 'âš™ï¸'; rightBtn.classList.remove('hidden'); currentScene = null; }
            else if (pageName === 'scene') { backBtn.classList.remove('hidden'); rightBtn.textContent = 'ğŸ¤–'; rightBtn.classList.remove('hidden'); rightBtn.onclick = () => showAIGenerateModal(); }
            else if (pageName === 'favorites') { backBtn.classList.add('hidden'); title.textContent = 'æˆ‘çš„æ”¶è—'; rightBtn.classList.add('hidden'); renderFavorites(); }
            else if (pageName === 'settings') { backBtn.classList.remove('hidden'); title.textContent = 'è®¾ç½®'; rightBtn.classList.add('hidden'); }
        }
        function openScene(sceneId, emoji, name, categoryKey) {
            currentScene = sceneId; currentCategoryKey = categoryKey;
            document.getElementById('sceneHeader').querySelector('.emoji').textContent = emoji;
            document.getElementById('sceneHeader').querySelector('h2').textContent = name;
            document.getElementById('headerTitle').textContent = name;
            renderPhrases(sceneId);
            showPage('scene');
        }
        function goBack() { if (currentPage === 'scene' || currentPage === 'settings') showPage('home'); }
        function isFavorite(de) { return favorites.some(f => f.de === de); }
        function toggleFavorite(de, zh, btn) {
            const idx = favorites.findIndex(f => f.de === de);
            if (idx >= 0) { favorites.splice(idx, 1); btn.classList.remove('favorited'); btn.textContent = 'â˜†'; showToast('å·²å–æ¶ˆæ”¶è—'); }
            else { favorites.push({ de, zh }); btn.classList.add('favorited'); btn.textContent = 'â­'; showToast('å·²æ”¶è—'); }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            if (currentPage === 'favorites') renderFavorites();
        }
        function clearFavorites() { if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ”¶è—å—ï¼Ÿ')) { favorites = []; localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavorites(); showToast('å·²æ¸…é™¤'); } }
        async function askAI() {
            const query = document.getElementById('aiInput').value.trim();
            if (!query) return;
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) { showToast('è¯·å…ˆé…ç½® API Key'); showPage('settings'); return; }
            const btn = document.getElementById('aiSearchBtn');
            const loading = document.getElementById('aiLoading');
            const result = document.getElementById('aiResult');
            btn.disabled = true; loading.classList.add('visible'); result.classList.remove('visible');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `ä½ æ˜¯å¾·è¯­å£è¯­åŠ©æ‰‹ã€‚ç”¨æˆ·æƒ³è¯´ï¼š${query}\nè¯·å›å¤ï¼š\nå¾·è¯­ï¼š[å¾·è¯­å¥å­]\nä¸­æ–‡ï¼š[ä¸­æ–‡ç¿»è¯‘]\nå¤‡æ³¨ï¼š[ä½¿ç”¨åœºæ™¯]` }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const deMatch = text.match(/å¾·è¯­[ï¼š:]\s*(.+)/);
                const zhMatch = text.match(/ä¸­æ–‡[ï¼š:]\s*(.+)/);
                const noteMatch = text.match(/å¤‡æ³¨[ï¼š:]\s*(.+)/);
                if (deMatch && zhMatch) {
                    lastAIResult = { de: deMatch[1].trim(), zh: zhMatch[1].trim(), note: noteMatch ? noteMatch[1].trim() : '' };
                    document.getElementById('aiResultGerman').textContent = lastAIResult.de;
                    document.getElementById('aiResultChinese').textContent = lastAIResult.zh;
                    document.getElementById('aiResultNote').textContent = lastAIResult.note;
                    result.classList.add('visible');
                } else showToast('AIè¿”å›æ ¼å¼æœ‰è¯¯');
            } catch (e) { showToast('æŸ¥è¯¢å¤±è´¥'); console.error(e); }
            finally { btn.disabled = false; loading.classList.remove('visible'); }
        }
        function saveAIResult() { if (lastAIResult && !isFavorite(lastAIResult.de)) { favorites.push({ de: lastAIResult.de, zh: lastAIResult.zh }); localStorage.setItem('favorites', JSON.stringify(favorites)); showToast('å·²æ”¶è—'); } else showToast('å·²æ”¶è—è¿‡äº†'); }
        function copyAIResult() { if (lastAIResult) { navigator.clipboard.writeText(lastAIResult.de).then(() => showToast('å·²å¤åˆ¶')); } }
        function loadApiKey() { document.getElementById('apiKeyInput').value = localStorage.getItem('geminiApiKey') || ''; }
        function saveApiKey() { localStorage.setItem('geminiApiKey', document.getElementById('apiKeyInput').value.trim()); showToast('å·²ä¿å­˜'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); }
        function esc(s) { return s.replace(/'/g, "\\'").replace(/"/g, '\\"'); }
        // Modal
        function showModal(title, bodyHtml, footerHtml) { document.getElementById('modalTitle').textContent = title; document.getElementById('modalBody').innerHTML = bodyHtml; document.getElementById('modalFooter').innerHTML = footerHtml; document.getElementById('modalOverlay').classList.add('visible'); }
        function closeModal(e) { if (!e || e.target === document.getElementById('modalOverlay')) document.getElementById('modalOverlay').classList.remove('visible'); }
        // Context Menu
        function showContextMenu(x, y, items) {
            const menu = document.getElementById('contextMenu');
            menu.innerHTML = items.map(i => `<button class="${i.danger ? 'danger' : ''}" onclick="${i.action}">${i.icon} ${i.label}</button>`).join('');
            menu.style.left = Math.min(x, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 100) + 'px';
            menu.classList.add('visible');
        }
        function hideContextMenu() { document.getElementById('contextMenu').classList.remove('visible'); }
        function startLongPress(e, type, ...args) { longPressTimer = setTimeout(() => { e.preventDefault(); if (type === 'scene') showSceneMenu(e, args[0], args[1]); else if (type === 'phrase') showPhraseMenu(e, args[0]); }, 500); }
        function cancelLongPress() { clearTimeout(longPressTimer); }
        // Add Category
        function showAddCategoryModal() {
            showModal('æ·»åŠ åˆ†ç±»', `<div class="form-group"><label>åˆ†ç±»åç§°</label><input type="text" id="newCategoryName" placeholder="å¦‚ï¼šæ—…æ¸¸ç±»"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addCategory()">æ·»åŠ </button>`);
        }
        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) { showToast('è¯·è¾“å…¥åç§°'); return; }
            if (categories[name]) { showToast('åˆ†ç±»å·²å­˜åœ¨'); return; }
            categories[name] = [];
            saveData(); renderCategories(); closeModal(); showToast('å·²æ·»åŠ ');
        }
        // Add Scene
        function showAddSceneModal(categoryKey) {
            currentCategoryKey = categoryKey;
            showModal('æ·»åŠ åœºæ™¯', `<div class="form-group"><label>é€‰æ‹©å›¾æ ‡</label><div class="emoji-picker" id="emojiPicker">${EMOJIS.map(e => `<button type="button" onclick="selectEmoji('${e}')">${e}</button>`).join('')}</div></div><div class="form-group"><label>åœºæ™¯åç§°</label><input type="text" id="newSceneName" placeholder="å¦‚ï¼šå’–å•¡å…"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addScene()">æ·»åŠ </button>`);
        }
        function selectEmoji(emoji) { document.querySelectorAll('.emoji-picker button').forEach(b => b.classList.remove('selected')); event.target.classList.add('selected'); }
        function addScene() {
            const name = document.getElementById('newSceneName').value.trim();
            const emojiBtn = document.querySelector('.emoji-picker button.selected');
            const emoji = emojiBtn ? emojiBtn.textContent : 'ğŸ“';
            if (!name) { showToast('è¯·è¾“å…¥åç§°'); return; }
            const id = 'scene_' + Date.now();
            categories[currentCategoryKey].push({ id, emoji, name });
            phrases[id] = [];
            saveData(); renderCategories(); closeModal(); showToast('å·²æ·»åŠ ');
        }
        // Scene Menu
        function showSceneMenu(e, categoryKey, sceneId) {
            e.preventDefault();
            showContextMenu(e.clientX || e.touches?.[0]?.clientX || 100, e.clientY || e.touches?.[0]?.clientY || 100, [
                { icon: 'âœï¸', label: 'ç¼–è¾‘', action: `editScene('${categoryKey}','${sceneId}')` },
                { icon: 'ğŸ—‘ï¸', label: 'åˆ é™¤', action: `deleteScene('${categoryKey}','${sceneId}')`, danger: true }
            ]);
        }
        function editScene(categoryKey, sceneId) {
            hideContextMenu();
            const scene = categories[categoryKey].find(s => s.id === sceneId);
            currentCategoryKey = categoryKey;
            showModal('ç¼–è¾‘åœºæ™¯', `<div class="form-group"><label>é€‰æ‹©å›¾æ ‡</label><div class="emoji-picker">${EMOJIS.map(e => `<button type="button" class="${e === scene.emoji ? 'selected' : ''}" onclick="selectEmoji('${e}')">${e}</button>`).join('')}</div></div><div class="form-group"><label>åœºæ™¯åç§°</label><input type="text" id="editSceneName" value="${scene.name}"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveEditScene('${sceneId}')">ä¿å­˜</button>`);
        }
        function saveEditScene(sceneId) {
            const name = document.getElementById('editSceneName').value.trim();
            const emojiBtn = document.querySelector('.emoji-picker button.selected');
            const emoji = emojiBtn ? emojiBtn.textContent : 'ğŸ“';
            if (!name) { showToast('è¯·è¾“å…¥åç§°'); return; }
            const scene = categories[currentCategoryKey].find(s => s.id === sceneId);
            scene.name = name; scene.emoji = emoji;
            saveData(); renderCategories(); closeModal(); showToast('å·²ä¿å­˜');
        }
        function deleteScene(categoryKey, sceneId) {
            hideContextMenu();
            if (confirm('ç¡®å®šåˆ é™¤æ­¤åœºæ™¯ï¼Ÿ')) {
                categories[categoryKey] = categories[categoryKey].filter(s => s.id !== sceneId);
                delete phrases[sceneId];
                saveData(); renderCategories(); showToast('å·²åˆ é™¤');
            }
        }
        // Add Phrase
        function showAddPhraseModal() {
            showModal('æ·»åŠ çŸ­å¥', `<div class="form-group"><label>å¾·è¯­</label><input type="text" id="newPhraseDE" placeholder="å¾·è¯­çŸ­å¥"></div><div class="form-group"><label>ä¸­æ–‡</label><input type="text" id="newPhraseZH" placeholder="ä¸­æ–‡ç¿»è¯‘"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addPhrase()">æ·»åŠ </button>`);
        }
        function addPhrase() {
            const de = document.getElementById('newPhraseDE').value.trim();
            const zh = document.getElementById('newPhraseZH').value.trim();
            if (!de || !zh) { showToast('è¯·å¡«å†™å®Œæ•´'); return; }
            if (!phrases[currentScene]) phrases[currentScene] = [];
            phrases[currentScene].push({ de, zh });
            saveData(); renderPhrases(currentScene); closeModal(); showToast('å·²æ·»åŠ ');
        }
        // Phrase Menu
        function showPhraseMenu(e, idx) {
            e.preventDefault();
            showContextMenu(e.clientX || e.touches?.[0]?.clientX || 100, e.clientY || e.touches?.[0]?.clientY || 100, [
                { icon: 'âœï¸', label: 'ç¼–è¾‘', action: `editPhrase(${idx})` },
                { icon: 'ğŸ—‘ï¸', label: 'åˆ é™¤', action: `deletePhrase(${idx})`, danger: true }
            ]);
        }
        function editPhrase(idx) {
            hideContextMenu();
            const p = phrases[currentScene][idx];
            showModal('ç¼–è¾‘çŸ­å¥', `<div class="form-group"><label>å¾·è¯­</label><input type="text" id="editPhraseDE" value="${p.de}"></div><div class="form-group"><label>ä¸­æ–‡</label><input type="text" id="editPhraseZH" value="${p.zh}"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveEditPhrase(${idx})">ä¿å­˜</button>`);
        }
        function saveEditPhrase(idx) {
            const de = document.getElementById('editPhraseDE').value.trim();
            const zh = document.getElementById('editPhraseZH').value.trim();
            if (!de || !zh) { showToast('è¯·å¡«å†™å®Œæ•´'); return; }
            phrases[currentScene][idx] = { de, zh };
            saveData(); renderPhrases(currentScene); closeModal(); showToast('å·²ä¿å­˜');
        }
        function deletePhrase(idx) { hideContextMenu(); if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { phrases[currentScene].splice(idx, 1); saveData(); renderPhrases(currentScene); showToast('å·²åˆ é™¤'); } }
        // AI Generate
        function showAIGenerateModal() {
            showModal('AI ç”ŸæˆçŸ­å¥', `<div class="form-group"><label>å¾·è¯­éš¾åº¦</label><div class="level-selector"><button class="level-btn selected" onclick="selectLevel(this)">A1</button><button class="level-btn" onclick="selectLevel(this)">A2</button><button class="level-btn" onclick="selectLevel(this)">B1</button></div></div><div class="form-group"><label>ç”Ÿæˆæ•°é‡</label><select id="aiGenCount"><option value="5">5ä¸ª</option><option value="10" selected>10ä¸ª</option><option value="15">15ä¸ª</option></select></div><button class="btn btn-primary" style="width:100%" onclick="generatePhrases()">ğŸ¤– ç”ŸæˆçŸ­å¥</button><div class="ai-loading" id="genLoading"><div class="spinner"></div><span>ç”Ÿæˆä¸­...</span></div><div class="generated-phrases" id="generatedPhrases"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button><button class="btn btn-primary" id="addGenBtn" style="display:none" onclick="addGeneratedPhrases()">æ·»åŠ é€‰ä¸­</button>`);
        }
        function selectLevel(btn) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        async function generatePhrases() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) { showToast('è¯·å…ˆé…ç½® API Key'); return; }
            const level = document.querySelector('.level-btn.selected').textContent;
            const count = document.getElementById('aiGenCount').value;
            const sceneName = document.getElementById('sceneHeader').querySelector('h2').textContent;
            const loading = document.getElementById('genLoading');
            const container = document.getElementById('generatedPhrases');
            loading.classList.add('visible'); container.innerHTML = '';
            const currentPhrases = (phrases[currentScene] || []).map(p => p.de).join(', ');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `ç”Ÿæˆ${count}ä¸ªå…³äº"${sceneName}"åœºæ™¯çš„å¾·è¯­${level}æ°´å¹³æ—¥å¸¸å£è¯­çŸ­å¥ã€‚
å·²æœ‰çŸ­å¥ï¼ˆè¯·ç»å¯¹ä¸è¦é‡å¤ä»¥ä¸‹å†…å®¹ï¼‰ï¼š${currentPhrases}
æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªï¼Œç”¨|åˆ†éš”å¾·è¯­å’Œä¸­æ–‡ã€‚ä¾‹å¦‚ï¼šGuten Tag!|ä½ å¥½ï¼
åªè¾“å‡ºçŸ­å¥ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚` }]
                        }]
                    })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const lines = text.split('\n').filter(l => l.includes('|'));
                if (lines.length === 0) { showToast('ç”Ÿæˆå¤±è´¥'); return; }
                container.innerHTML = lines.map((l, i) => {
                    const [de, zh] = l.split('|').map(s => s.trim());
                    return `<div class="generated-phrase"><input type="checkbox" checked id="gen${i}"><div class="generated-phrase-content"><div class="de">${de}</div><div class="zh">${zh}</div></div></div>`;
                }).join('');
                document.getElementById('addGenBtn').style.display = 'block';
            } catch (e) { showToast('ç”Ÿæˆå¤±è´¥'); console.error(e); }
            finally { loading.classList.remove('visible'); }
        }
        function addGeneratedPhrases() {
            const items = document.querySelectorAll('.generated-phrase');
            let added = 0;
            items.forEach((item, i) => {
                if (item.querySelector('input').checked) {
                    const de = item.querySelector('.de').textContent;
                    const zh = item.querySelector('.zh').textContent;
                    if (!phrases[currentScene]) phrases[currentScene] = [];
                    phrases[currentScene].push({ de, zh });
                    added++;
                }
            });
            saveData(); renderPhrases(currentScene); closeModal(); showToast(`å·²æ·»åŠ ${added}ä¸ªçŸ­å¥`);
        }
        // Export/Import
        function exportData() {
            const data = { categories, phrases, favorites };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'german-survival-backup.json';
            a.click();
            showToast('å·²å¯¼å‡º');
        }
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.categories) categories = data.categories;
                    if (data.phrases) phrases = data.phrases;
                    if (data.favorites) favorites = data.favorites;
                    saveData();
                    localStorage.setItem('favorites', JSON.stringify(favorites));
                    renderCategories(); renderFavorites();
                    showToast('å·²å¯¼å…¥');
                } catch (err) { showToast('å¯¼å…¥å¤±è´¥'); }
            };
            reader.readAsText(file);
        }
        function resetToDefault() {
            if (confirm('ç¡®å®šæ¢å¤é»˜è®¤æ•°æ®ï¼Ÿè‡ªå®šä¹‰å†…å®¹å°†ä¸¢å¤±ã€‚')) {
                categories = JSON.parse(JSON.stringify(DEFAULT_DATA.categories));
                phrases = JSON.parse(JSON.stringify(DEFAULT_DATA.phrases));
                saveData(); renderCategories(); showToast('å·²æ¢å¤');
            }
        }
        init();
    </script>
</body>

</html>